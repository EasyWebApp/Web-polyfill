"use strict";var e=function(){return e=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},e.apply(this,arguments)};function t(e,t,n,o){return new(n||(n=Promise))(function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function u(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,u)}s((o=o.apply(e,t||[])).next())})}function n(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=u(0),a.throw=u(1),a.return=u(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(u){return function(s){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&u[0]?o.return:u[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,u[1])).done)return r;switch(o=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,o=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){i.label=u[1];break}if(6===u[0]&&i.label<r[1]){i.label=r[1],r=u;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(u);break}r[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(e,i)}catch(e){u=[6,e],o=0}finally{n=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,s])}}}function o(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)a.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return a}function r(e,t,n){if(n||2===arguments.length)for(var o,r=0,i=t.length;r<i;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var i=function(){function e(e){var t=e.key,n=e.heartBeatIntervalTime,o=void 0===n?1e3:n,r=e.heartBeatDetectIntervalTime,i=void 0===r?2e3:r,a=this;this._heartBeatIntervalId=null,this._heartBeatDetectIntervalId=null,this._key=t,this._heartBeatIntervalTime=o,this._heartBeatDetectIntervalTime=i,window.addEventListener("unload",function(){a.destroy()})}return e.prototype.start=function(){var e=this;this._heartBeatIntervalId=setInterval(function(){e._setLocalTime()},this._heartBeatIntervalTime)},e.prototype.destroy=function(){this._heartBeatIntervalId&&clearInterval(this._heartBeatIntervalId),this._heartBeatDetectIntervalId&&clearInterval(this._heartBeatDetectIntervalId)},e.prototype._setLocalTime=function(){window.localStorage.setItem(this._key,Date.now().toString())},e.prototype.detect=function(e){this._heartBeatDetectIntervalId=setInterval(function(){e()},this._heartBeatDetectIntervalTime)},e}();function a(e,t){window.localStorage.setItem(e,t),function(e,t){var n=new Event(e);n.value=t,n.key=e,document.dispatchEvent(n)}(e,t)}function u(e){return window.localStorage.getItem(e)}function s(e,o){var r=function(){return t(this,void 0,void 0,function(){return n(this,function(t){switch(t.label){case 0:return[4,o()];case 1:return t.sent()&&document.removeEventListener(e,r),[2]}})})};document.addEventListener(e,r,!1);var i=function(r){return t(this,void 0,void 0,function(){return n(this,function(t){switch(t.label){case 0:return r.storageArea!==localStorage||r.key!==e?[3,2]:[4,o()];case 1:t.sent()&&window.removeEventListener("storage",i),t.label=2;case 2:return[2]}})})};window.addEventListener("storage",i,!1)}var c,l={EXCLUSIVE:"exclusive",SHARED:"shared"};function d(){return"".concat((new Date).getTime(),"-").concat(String(Math.random()).substring(2))}!function(e){e.REQUEST_QUEUE_MAP="$navigator.locks-requestQueueMap",e.HELD_LOCK_SET="$navigator.locks-heldLockSet",e.CLIENT_IDS="$navigator.locks-clientIds"}(c||(c={}));var h=function(){function h(){this._defaultOptions={mode:l.EXCLUSIVE,ifAvailable:!1,steal:!1},this._clientId="".concat("$navigator.locks","-clientId-").concat(d()),this._init()}return h.prototype._init=function(){var e=this;this._storeThisClientId();var t=new i({key:this._clientId});t.start(),t.detect(function(){return e._cleanUnliveClientLocks()}),this._onUnload()},h.prototype._getClientIds=function(){var e=u(c.CLIENT_IDS);return e&&JSON.parse(e)||[]},h.prototype._storeClientIds=function(e){a(c.CLIENT_IDS,JSON.stringify(e))},h.prototype._storeThisClientId=function(){var e=r(r([],o(this._getClientIds()),!1),[this._clientId],!1);this._storeClientIds(e)},h.prototype.request=function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];return t(this,void 0,void 0,function(){var t;return n(this,function(n){return t=this,[2,new Promise(function(n,o){var r=t._handleRequestArgs(e,o);if(r){var i=r.cb,a=r._options,u=e[0],s={name:u,mode:a.mode,clientId:t._clientId,uuid:"".concat(u,"-").concat(d()),resolve:n,reject:o,signal:a.signal},c=t._resolveWithCB(i,n,o),h=t._heldLockSet(),f=h.find(function(e){return e.name===s.name}),p=t._requestLockQueueMap()[s.name]||[];if(!0===a.steal)f=(h=h.filter(function(e){return e.name!==s.name})).find(function(e){return e.name===s.name});else{if(!0===a.ifAvailable)return f&&(f.mode!==l.SHARED||s.mode!==l.SHARED)||p.length?c(null):t._handleNewHeldLock(s,c);if(void 0!==a.signal&&!t._handleSignalExisted(a,o,s))return}t._handleHeldLockAndRequest(f,s,c,p,h)}})]})})},h.prototype.query=function(){return t(this,void 0,void 0,function(){return n(this,function(e){return[2,this._query()]})})},h.prototype._pushToLockRequestQueueMap=function(e){var t=this._requestLockQueueMap(),n=t[e.name]||[];return t[e.name]=r(r([],o(n),!1),[e],!1),this._storeRequestLockQueueMap(t),e},h.prototype._pushToHeldLockSet=function(e,t){void 0===t&&(t=this._heldLockSet());var n=r(r([],o(t),!1),[e],!1);return this._storeHeldLockSet(n),e},h.prototype._requestLockQueueMap=function(){var e=u(c.REQUEST_QUEUE_MAP);return e&&JSON.parse(e)||{}},h.prototype._heldLockSet=function(){var e=u(c.HELD_LOCK_SET);return e&&JSON.parse(e)||[]},h.prototype._updateHeldAndRequestLocks=function(e){var t=this._heldLockSet(),n=t.findIndex(function(t){return t.uuid===e.uuid});if(-1!==n){t.splice(n,1);var i=this._requestLockQueueMap(),a=i[e.name]||[],u=o(a),s=u[0],c=u.slice(1);if(s){if(s.mode===l.EXCLUSIVE||0===c.length)t.push(s),i[e.name]=c;else if(s.mode===l.SHARED){var d=a.findIndex(function(e){return e.mode!==l.SHARED});-1===d&&(d=a.length),t=r(r([],o(t),!1),o(a.splice(0,d)),!1)}return this._storeHeldLockSetAndRequestLockQueueMap(t,i),s}this._storeHeldLockSet(t)}else console.log("this held lock which uuid is ".concat(e.uuid," had been steal"))},h.prototype._getAbortError=function(e){return e.reason||new DOMException("The request was aborted.","AbortError")},h.prototype._handleSignalExisted=function(e,t,n){var o=e.signal;if(!(o instanceof AbortSignal))return t(new TypeError("Failed to execute 'request' on 'LockManager': member signal is not of type AbortSignal.")),!1;if(o.aborted)return t(this._getAbortError(o)),!1;var r=this._signalOnabort(o,n);return o.addEventListener("abort",r),n.closeSignal=function(){return o.removeEventListener("abort",r)},!0},h.prototype._handleRequestArgs=function(t,n){var o,r,i=t.length;if(i<2)return n(new TypeError("Failed to execute 'request' on 'LockManager': 2 arguments required, but only ".concat(t.length," present."))),null;if(2===i){if("function"!=typeof t[1])return n(new TypeError("Failed to execute 'request' on 'LockManager': parameter 2 is not of type 'Function'.")),null;o=t[1],r=this._defaultOptions}else{if("function"!=typeof t[2])return n(new TypeError("Failed to execute 'request' on 'LockManager': parameter 3 is not of type 'Function'.")),null;o=t[2],r=e(e({},this._defaultOptions),t[1])}return Object.values(l).indexOf(r.mode)<0?(n(new TypeError("Failed to execute 'request' on 'LockManager': The provided value '".concat(r.mode,"' is not a valid enum value of type LockMode."))),null):"-"===t[0][0]?(n(new DOMException("Failed to execute 'request' on 'LockManager': Names cannot start with '-'.","NotSupportedError")),null):r.signal&&r.steal?(n(new DOMException("Failed to execute 'request' on 'LockManager': The 'signal' and 'steal' options cannot be used together.","NotSupportedError")),null):r.signal&&r.ifAvailable?(n(new DOMException("Failed to execute 'request' on 'LockManager': The 'signal' and 'ifAvailable' options cannot be used together.","NotSupportedError")),null):r.steal&&r.ifAvailable?(n(new DOMException("Failed to execute 'request' on 'LockManager': The 'steal' and 'ifAvailable' options cannot be used together.","NotSupportedError")),null):r.steal&&r.mode!==l.EXCLUSIVE?(n(new DOMException("Failed to execute 'request' on 'LockManager': The 'steal' option may only be used with 'exclusive' locks.","NotSupportedError")),null):{cb:o,_options:r}},h.prototype._handleHeldLockAndRequest=function(e,t,n,o,r){e?e.mode===l.EXCLUSIVE?this._handleNewLockRequest(t,n):e.mode===l.SHARED&&(t.mode===l.SHARED&&0===o.length?this._handleNewHeldLock(t,n,r):this._handleNewLockRequest(t,n)):this._handleNewHeldLock(t,n,r)},h.prototype._signalOnabort=function(e,t){var n=this,o=t.name,r=t.uuid,i=t.reject;return function(){var t=n._requestLockQueueMap(),a=t[o];if(a){var u=a.findIndex(function(e){return e.uuid===r});-1!==u&&(a.splice(u,1),n._storeRequestLockQueueMap(t))}i(n._getAbortError(e))}},h.prototype._resolveWithCB=function(e,o,r){var i=this;return function(a){return new Promise(function(u){new Promise(function(e){return e("")}).then(function(){return t(i,void 0,void 0,function(){var t,i;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,e(a)];case 1:return t=n.sent(),u(t),o(t),[3,3];case 2:return i=n.sent(),u(i),r(i),[3,3];case 3:return[2]}})})})})}},h.prototype._handleNewHeldLock=function(e,o,r){return t(this,void 0,void 0,function(){var t,i,a,u,l,d=this;return n(this,function(n){switch(n.label){case 0:return this._pushToHeldLockSet(e,r),[4,new Promise(function(e){return setTimeout(e,0)})];case 1:return n.sent(),null===(u=e.closeSignal)||void 0===u||u.call(e),(null===(l=e.signal)||void 0===l?void 0:l.aborted)?(this._updateHeldAndRequestLocks(e),[2,e.reject(this._getAbortError(e.signal))]):(t=!1,i=!1,a=function(){return!(t||i||d._isInHeldLockSet(e.uuid))&&(d._handleHeldLockBeSteal(e),i=!0,!0)},s(c.HELD_LOCK_SET,a),o({name:e.name,mode:e.mode}).then(function(){t=!0,d._updateHeldAndRequestLocks(e)}),[2])}})})},h.prototype._handleHeldLockBeSteal=function(e){e.reject(new DOMException("Lock broken by another request with the 'steal' option."))},h.prototype._storeHeldLockSet=function(e){a(c.HELD_LOCK_SET,JSON.stringify(e))},h.prototype._storeRequestLockQueueMap=function(e){a(c.REQUEST_QUEUE_MAP,JSON.stringify(e))},h.prototype._isInHeldLockSet=function(e){return this._heldLockSet().some(function(t){return t.uuid===e})},h.prototype._handleNewLockRequest=function(e,o){var r=this;this._pushToLockRequestQueueMap(e);var i=!1;s(c.HELD_LOCK_SET,function(){return t(r,void 0,void 0,function(){return n(this,function(t){switch(t.label){case 0:return i||!this._isInHeldLockSet(e.uuid)?[3,5]:(i=!0,[4,o({name:e.name,mode:e.mode})]);case 1:return t.sent(),this._isInHeldLockSet(e.uuid)||this._handleHeldLockBeSteal(e),e.mode!==l.EXCLUSIVE?[3,2]:(this._updateHeldAndRequestLocks(e),[3,4]);case 2:return e.mode!==l.SHARED?[3,4]:[4,this._handleSharedLockFromListener(e)];case 3:t.sent(),t.label=4;case 4:return[2,!0];case 5:return[2,!1]}})})})},h.prototype._handleSharedLockFromListener=function(e){return t(this,void 0,void 0,function(){var t;return n(this,function(n){switch(n.label){case 0:return[4,(o=Math.floor(1e3*Math.random()),new Promise(function(e){return setTimeout(e,o)}))];case 1:return n.sent(),(t=this._heldLockSet().filter(function(t){return t.name===e.name&&t.uuid!==e.uuid&&t.mode===l.SHARED})).length?this._storeHeldLockSet(t):this._updateHeldAndRequestLocks(e),[2]}var o})})},h.prototype._storeHeldLockSetAndRequestLockQueueMap=function(e,t){this._storeHeldLockSet(e),this._storeRequestLockQueueMap(t)},h.prototype._query=function(){var e={held:this._heldLockSet(),pending:[]},t=this._requestLockQueueMap();for(var n in t){var o=t[n];e.pending=e.pending.concat(o)}return e},h.prototype._onUnload=function(){var e=this;window.addEventListener("unload",function(t){e._cleanClientLocksByClientId(e._clientId)})},h.prototype._cleanClientLocksByClientId=function(e){var t=this._requestLockQueueMap();this._cleanRequestLockQueueByClientId(t,e);var n=this._cleanHeldLockSetByClientId(t,e);this._storeHeldLockSetAndRequestLockQueueMap(n,t)},h.prototype._cleanHeldLockSetByClientId=function(e,t){var n=this._heldLockSet(),i=[];return n.forEach(function(n){if(n.clientId!==t)i.push(n);else{var a=e[n.name]||[],u=o(a),s=u[0],c=u.slice(1);if(s)if(s.mode===l.EXCLUSIVE||0===c.length)i.push(s),e[n.name]=c;else if(s.mode===l.SHARED){var d=a.findIndex(function(e){return e.mode!==l.SHARED});-1===d&&(d=a.length),i=r(r([],o(i),!1),o(a.splice(0,d)),!1)}}}),i},h.prototype._cleanRequestLockQueueByClientId=function(e,t){for(var n in e){var o=e[n];e[n]=o.filter(function(e){return e.clientId!==t})}},h.prototype._cleanUnliveClientLocks=function(){var e=this,t=r([],o(new Set(this._getClientIds())),!1);if(t.length){var n=[];t.forEach(function(t){var o,r=u(t);!r||Date.now()-Number(r)>3100?(o=t,window.localStorage.removeItem(o),e._cleanClientLocksByClientId(t)):n.push(t)}),JSON.stringify(t)!==JSON.stringify(n)&&this._storeClientIds(n)}else this._storeClientIds([])},h}();!function(){if("undefined"!=typeof window){var e=window.navigator;if(e&&!e.locks){var t=new h;Object.defineProperty(e,"locks",{value:t})}}}();
