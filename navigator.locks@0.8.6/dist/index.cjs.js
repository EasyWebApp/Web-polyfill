"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var e=function(){return(e=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function t(e,t,n,o){return new(n||(n=Promise))((function(r,i){function u(e){try{s(o.next(e))}catch(e){i(e)}}function a(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,a)}s((o=o.apply(e,t||[])).next())}))}function n(e,t){var n,o,r,i,u={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,o=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(r=u.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){u.label=i[1];break}if(6===i[0]&&u.label<r[1]){u.label=r[1],r=i;break}if(r&&u.label<r[2]){u.label=r[2],u.ops.push(i);break}r[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function o(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),u=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)u.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return u}function r(e,t){for(var n=0,o=t.length,r=e.length;n<o;n++,r++)e[r]=t[n];return e}var i=function(){function e(e){var t=this,n=e.key,o=e.heartBeatIntervalTime,r=void 0===o?1e3:o,i=e.heartBeatDetectIntervalTime,u=void 0===i?2e3:i;this._heartBeatIntervalId=null,this._heartBeatDetectIntervalId=null,this._key=n,this._heartBeatIntervalTime=r,this._heartBeatDetectIntervalTime=u,window.addEventListener("unload",(function(){t.destroy()}))}return e.prototype.start=function(){var e=this;this._heartBeatIntervalId=setInterval((function(){e._setLocalTime()}),this._heartBeatIntervalTime)},e.prototype.destroy=function(){this._heartBeatIntervalId&&clearInterval(this._heartBeatIntervalId),this._heartBeatDetectIntervalId&&clearInterval(this._heartBeatDetectIntervalId)},e.prototype._setLocalTime=function(){window.localStorage.setItem(this._key,Date.now().toString())},e.prototype.detect=function(e){this._heartBeatDetectIntervalId=setInterval((function(){e()}),this._heartBeatDetectIntervalTime)},e}();function u(e,t){window.localStorage.setItem(e,t),function(e,t){var n=new Event(e);n.value=t,n.key=e,document.dispatchEvent(n)}(e,t)}function a(e){return window.localStorage.getItem(e)}function s(e,o){var r=function(){return t(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,o()];case 1:return t.sent()&&document.removeEventListener(e,r),[2]}}))}))};document.addEventListener(e,r,!1);var i=function(r){return t(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return r.storageArea!==localStorage||r.key!==e?[3,2]:[4,o()];case 1:t.sent()&&window.removeEventListener("storage",i),t.label=2;case 2:return[2]}}))}))};window.addEventListener("storage",i,!1)}var c,l={EXCLUSIVE:"exclusive",SHARED:"shared"};function d(){return(new Date).getTime()+"-"+String(Math.random()).substring(2)}!function(e){e.REQUEST_QUEUE_MAP="$navigator.locks-requestQueueMap",e.HELD_LOCK_SET="$navigator.locks-heldLockSet",e.CLIENT_IDS="$navigator.locks-clientIds"}(c||(c={}));var h=function(){function h(){this._defaultOptions={mode:l.EXCLUSIVE,ifAvailable:!1,steal:!1},this._clientId="$navigator.locks-clientId-"+d(),this._init()}return h.prototype._init=function(){var e=this;this._storeThisClientId();var t=new i({key:this._clientId});t.start(),t.detect((function(){return e._cleanUnliveClientLocks()})),this._onUnload()},h.prototype._getClientIds=function(){var e=a(c.CLIENT_IDS);return e&&JSON.parse(e)||[]},h.prototype._storeClientIds=function(e){u(c.CLIENT_IDS,JSON.stringify(e))},h.prototype._storeThisClientId=function(){var e=r(r([],o(this._getClientIds())),[this._clientId]);this._storeClientIds(e)},h.prototype.request=function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];return t(this,void 0,void 0,(function(){var o;return n(this,(function(r){return o=this,[2,new Promise((function(r,i){return t(this,void 0,void 0,(function(){var t,u,a,s,c,h,f,p,v;return n(this,(function(n){if(!(t=o._handleRequestArgs(e,i)))return[2];if(u=t.cb,a=t._options,s=e[0],c={name:s,mode:a.mode,clientId:o._clientId,uuid:s+"-"+d(),resolve:r,reject:i},h=o._resolveWithCB(u,r,i),f=o._heldLockSet(),p=f.find((function(e){return e.name===c.name})),v=o._requestLockQueueMap()[c.name]||[],!0===a.steal){if(!o._handleExceptionWhenStealIsTrue(a,i))return[2];f=f.filter((function(e){return e.name!==c.name})),p=f.find((function(e){return e.name===c.name}))}else{if(!0===a.ifAvailable)return p&&(p.mode!==l.SHARED||c.mode!==l.SHARED)||v.length?[2,h(null)]:[2,o._handleNewHeldLock(c,h)];if(void 0!==a.signal&&!o._handleSignalExisted(a,i,c))return[2]}return o._handleHeldLockAndRequest(p,c,h,v,f),[2]}))}))}))]}))}))},h.prototype.query=function(){return t(this,void 0,void 0,(function(){return n(this,(function(e){return[2,this._query()]}))}))},h.prototype._pushToLockRequestQueueMap=function(e){var t=this._requestLockQueueMap(),n=t[e.name]||[];return t[e.name]=r(r([],o(n)),[e]),this._storeRequestLockQueueMap(t),e},h.prototype._pushToHeldLockSet=function(e,t){void 0===t&&(t=this._heldLockSet());var n=r(r([],o(t)),[e]);return this._storeHeldLockSet(n),e},h.prototype._requestLockQueueMap=function(){var e=a(c.REQUEST_QUEUE_MAP);return e&&JSON.parse(e)||{}},h.prototype._heldLockSet=function(){var e=a(c.HELD_LOCK_SET);return e&&JSON.parse(e)||[]},h.prototype._updateHeldAndRequestLocks=function(e){var t=this._heldLockSet(),n=t.findIndex((function(t){return t.uuid===e.uuid}));if(-1!==n){t.splice(n,1);var i=this._requestLockQueueMap(),u=i[e.name]||[],a=o(u),s=a[0],c=a.slice(1);if(s){if(s.mode===l.EXCLUSIVE||0===c.length)t.push(s),i[e.name]=c;else if(s.mode===l.SHARED){var d=u.findIndex((function(e){return e.mode!==l.SHARED}));-1===d&&(d=u.length),t=r(r([],o(t)),o(u.splice(0,d)))}return this._storeHeldLockSetAndRequestLockQueueMap(t,i),s}this._storeHeldLockSet(t)}else console.log("this held lock which uuid is "+e.uuid+" had been steal")},h.prototype._handleSignalExisted=function(e,t,n){return e.signal instanceof AbortSignal?e.signal.aborted?(t(new DOMException("Failed to execute 'request' on 'LockManager': The request was aborted.")),!1):(this._signalOnabort(e.signal,n),!0):(t(new TypeError("Failed to execute 'request' on 'LockManager': member signal is not of type AbortSignal.")),!1)},h.prototype._handleExceptionWhenStealIsTrue=function(e,t){return e.mode!==l.EXCLUSIVE?(t(new DOMException("Failed to execute 'request' on 'LockManager': The 'steal' option may only be used with 'exclusive' locks.")),!1):!0!==e.ifAvailable||(t(new DOMException("Failed to execute 'request' on 'LockManager': The 'steal' and 'ifAvailable' options cannot be used together.")),!1)},h.prototype._handleRequestArgs=function(t,n){var o,r,i=t.length;if(i<2)return n(new TypeError("Failed to execute 'request' on 'LockManager': 2 arguments required, but only "+t.length+" present.")),null;if(2===i){if("function"!=typeof t[1])return n(new TypeError("Failed to execute 'request' on 'LockManager': parameter 2 is not of type 'Function'.")),null;o=t[1],r=this._defaultOptions}else{if("function"!=typeof t[2])return n(new TypeError("Failed to execute 'request' on 'LockManager': parameter 3 is not of type 'Function'.")),null;o=t[2],r=e(e({},this._defaultOptions),t[1])}return Object.values(l).indexOf(r.mode)<0?(n(new TypeError("Failed to execute 'request' on 'LockManager': The provided value '"+r.mode+"' is not a valid enum value of type LockMode.")),null):"-"===t[0][0]?(n(new DOMException("Failed to execute 'request' on 'LockManager': Names cannot start with '-'.")),null):{cb:o,_options:r}},h.prototype._handleHeldLockAndRequest=function(e,t,n,o,r){e?e.mode===l.EXCLUSIVE?this._handleNewLockRequest(t,n):e.mode===l.SHARED&&(t.mode===l.SHARED&&0===o.length?this._handleNewHeldLock(t,n,r):this._handleNewLockRequest(t,n)):this._handleNewHeldLock(t,n,r)},h.prototype._signalOnabort=function(e,t){var n=this,o=t.name,r=t.uuid;e.onabort=function(){var e=n._requestLockQueueMap(),t=e[o].findIndex((function(e){return e.uuid===r}));-1!==t&&(e[o].splice(t,1),n._storeRequestLockQueueMap(e))}},h.prototype._resolveWithCB=function(e,o,r){var i=this;return function(u){return new Promise((function(a){new Promise((function(e){return e("")})).then((function(){return t(i,void 0,void 0,(function(){var t,i;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,e(u)];case 1:return t=n.sent(),a(t),o(t),[3,3];case 2:return i=n.sent(),a(i),r(i),[3,3];case 3:return[2]}}))}))}))}))}},h.prototype._handleNewHeldLock=function(e,o,r){return t(this,void 0,void 0,(function(){var t,i,u,a=this;return n(this,(function(n){return this._pushToHeldLockSet(e,r),t=!1,i=!1,u=function(){return!(t||i||a._isInHeldLockSet(e.uuid))&&(a._handleHeldLockBeSteal(e),i=!0,!0)},s(c.HELD_LOCK_SET,u),o({name:e.name,mode:e.mode}).then((function(){t=!0,a._updateHeldAndRequestLocks(e)})),[2]}))}))},h.prototype._handleHeldLockBeSteal=function(e){e.reject(new DOMException("Lock broken by another request with the 'steal' option."))},h.prototype._storeHeldLockSet=function(e){u(c.HELD_LOCK_SET,JSON.stringify(e))},h.prototype._storeRequestLockQueueMap=function(e){u(c.REQUEST_QUEUE_MAP,JSON.stringify(e))},h.prototype._isInHeldLockSet=function(e){return this._heldLockSet().some((function(t){return t.uuid===e}))},h.prototype._handleNewLockRequest=function(e,o){var r=this;this._pushToLockRequestQueueMap(e);var i=!1;s(c.HELD_LOCK_SET,(function(){return t(r,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return i||!this._isInHeldLockSet(e.uuid)?[3,5]:(i=!0,[4,o({name:e.name,mode:e.mode})]);case 1:return t.sent(),this._isInHeldLockSet(e.uuid)||this._handleHeldLockBeSteal(e),e.mode!==l.EXCLUSIVE?[3,2]:(this._updateHeldAndRequestLocks(e),[3,4]);case 2:return e.mode!==l.SHARED?[3,4]:[4,this._handleSharedLockFromListener(e)];case 3:t.sent(),t.label=4;case 4:return[2,!0];case 5:return[2,!1]}}))}))}))},h.prototype._handleSharedLockFromListener=function(e){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,(o=Math.floor(1e3*Math.random()),new Promise((function(e){return setTimeout(e,o)})))];case 1:return n.sent(),(t=this._heldLockSet().filter((function(t){return t.name===e.name&&t.uuid!==e.uuid&&t.mode===l.SHARED}))).length?this._storeHeldLockSet(t):this._updateHeldAndRequestLocks(e),[2]}var o}))}))},h.prototype._storeHeldLockSetAndRequestLockQueueMap=function(e,t){this._storeHeldLockSet(e),this._storeRequestLockQueueMap(t)},h.prototype._query=function(){var e={held:this._heldLockSet(),pending:[]},t=this._requestLockQueueMap();for(var n in t){var o=t[n];e.pending=e.pending.concat(o)}return e},h.prototype._onUnload=function(){var e=this;window.addEventListener("unload",(function(t){e._cleanClientLocksByClientId(e._clientId)}))},h.prototype._cleanClientLocksByClientId=function(e){var t=this._requestLockQueueMap();this._cleanRequestLockQueueByClientId(t,e);var n=this._cleanHeldLockSetByClientId(t,e);this._storeHeldLockSetAndRequestLockQueueMap(n,t)},h.prototype._cleanHeldLockSetByClientId=function(e,t){var n=this._heldLockSet(),i=[];return n.forEach((function(n){if(n.clientId!==t)i.push(n);else{var u=e[n.name]||[],a=o(u),s=a[0],c=a.slice(1);if(s)if(s.mode===l.EXCLUSIVE||0===c.length)i.push(s),e[n.name]=c;else if(s.mode===l.SHARED){var d=u.findIndex((function(e){return e.mode!==l.SHARED}));-1===d&&(d=u.length),i=r(r([],o(i)),o(u.splice(0,d)))}}})),i},h.prototype._cleanRequestLockQueueByClientId=function(e,t){for(var n in e){var o=e[n];e[n]=o.filter((function(e){return e.clientId!==t}))}},h.prototype._cleanUnliveClientLocks=function(){var e=this,t=r([],o(new Set(this._getClientIds())));if(t.length){var n=[];t.forEach((function(t){var o,r=a(t);!r||Date.now()-Number(r)>3100?(o=t,window.localStorage.removeItem(o),e._cleanClientLocksByClientId(t)):n.push(t)})),JSON.stringify(t)!==JSON.stringify(n)&&this._storeClientIds(n)}else this._storeClientIds([])},h}();!function(){if("undefined"!=typeof window){var e=window.navigator;if(e&&!e.locks){var t=new h;Object.defineProperty(e,"locks",{value:t})}}}();
